<!-- Only show controls if we have cards -->
<ng-container *ngIf="cards.length > 0">
  <ng-container *ngTemplateOutlet="navigationControls"></ng-container>
</ng-container>

<div
  class="card-wrapper"
  [ngClass]="{
    'intro-card': activeCard.type === 'intro',
    'outro-card': activeCard.type === 'outro',
    transitioning: isTransitioning
  }"
>
  <!-- activeCard is either current or (during transition) next -->
  <ng-container
    *ngTemplateOutlet="activeCard.type === 'card' ? cardTemplate : textOnlyTemplate;
                        context: { $implicit: activeCard, isNext: isTransitioning && activeCard === cards[nextIndex] }">
  </ng-container>
</div>

<!-- intro/outro full-screen text -->
<ng-template #textOnlyTemplate let-card>
  <div class="text-only-card">
    <div
      class="text-content"
      [ngClass]="{
        visible: card.status === 'visible',
        hidden: card.status === 'hidden',
        'transitioning-in': card.status === 'transitioning-in',
        'transitioning-out': card.status === 'transitioning-out'
      }"
    >
      <h2>{{ card.title | translate }}</h2>
      <p>{{ card.description | translate }}</p>
    </div>
  </div>
</ng-template>

<!-- regular three-column card -->
<ng-template #cardTemplate let-card let-isNext="isNext">
  <div
    class="three-column-layout"
    [ngClass]="{
      'next-card': isNext,
      hidden: card.status === 'hidden',
      visible: card.status === 'visible',
      current: card.position === 'current',
      before: card.position === 'before',
      after: card.position === 'after'
    }"
  >
    <!-- Left: Text -->
    <div class="text-column">
      <div
        class="text-content"
        [ngClass]="{
          visible: card.status === 'visible',
          hidden: card.status === 'hidden',
          'transitioning-in': card.status === 'transitioning-in',
          'transitioning-out': card.status === 'transitioning-out'
        }"
      >
        <h2>{{ card.title | translate }}</h2>
        <p class="description">{{ card.description | translate }}</p>
      </div>
    </div>

    <!-- Center: Image -->
    <div class="image-column" *ngIf="card.image">
      <div
        class="image-container"
        [ngClass]="{
          visible: card.status === 'visible',
          before: card.position === 'before',
          after: card.position === 'after',
          'slide-in-from-left': card.position === 'slide-in-from-left',
          'slide-in-from-right': card.position === 'slide-in-from-right'
        }"
      >
        <img [src]="card.image" [alt]="card.title" />
      </div>
    </div>

    <!-- Right: Comics -->
    <div class="comic-column" *ngIf="card.comics?.length">
      <div
        class="comic-container"
        [ngClass]="{
          visible: card.status === 'visible',
          hidden: card.status === 'hidden',
          'transitioning-in': card.status === 'transitioning-in',
          'transitioning-out': card.status === 'transitioning-out'
        }"
      >
        <img
          *ngFor="let comic of card.comics"
          [src]="comic"
          [alt]="card.title + ' comic'"
          class="comic-image"
        />
      </div>
    </div>
  </div>

  <!-- comments (below both current & next) -->
  <div
    class="comments-section-separate"
    *ngIf="showCommentsSection && card.showComments"
  >
    <app-comments
      [cardId]="card.title"
      (commentAdded)="onCommentAdded($event)"
    ></app-comments>
  </div>
</ng-template>

<ng-template #navigationControls>
  <div class="navigation-controls">
    <button
      class="nav-btn prev-btn"
      (click)="previousCard()"
      [disabled]="currentIndex === 0 || isTransitioning"
      aria-label="Previous card"
    >
      <i class="fas fa-chevron-left"></i>
    </button>

    <div class="card-indicator">
      <span class="current">{{ currentIndex + 1 }}</span>
      <span class="separator">/</span>
      <span class="total">{{ cards.length }}</span>
    </div>

    <button
      class="nav-btn next-btn"
      (click)="nextCard()"
      [disabled]="currentIndex === cards.length - 1 || isTransitioning"
      aria-label="Next card"
    >
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</ng-template>
