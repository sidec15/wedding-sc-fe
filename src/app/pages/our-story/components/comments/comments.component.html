<div class="comments-section">
  <!-- Comments List -->
  <div class="comments-list-section">
    <h4 class="section-title">
      {{ "our_story.comments.title" | translate }} ({{
        totalCount ?? comments.length
      }})
    </h4>

    @if (isInitialLoading) {
    <div class="loading">
      {{ "our_story.comments.loading" | translate }}
    </div>
    } @else if (comments.length > 0) {
    <div class="comments-list">
      @for (comment of comments; track comment.commentId) {
      <div class="comment-item">
        <div class="comment-header">
          <span class="comment-author">{{ comment.authorName }}</span>
          <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
        </div>
        <div
          class="comment-content"
          [innerHTML]="comment.content | safeHtml"
        ></div>
      </div>
      } @if (hasNext) {
      <div class="load-more">
        <button
          type="button"
          class="submit-btn"
          (click)="loadComments(false)"
          [disabled]="isLoadingMore"
        >
          @if (!isLoadingMore) {
          {{ "our_story.comments.load_more" | translate }}
          } @else {
          {{ "our_story.comments.loading" | translate }}
          }
        </button>
      </div>
      }
    </div>
    } @else {
    <div class="no-comments">
      <p>{{ "our_story.comments.no_comment" | translate }}</p>
    </div>
    }
  </div>

  <!-- Comment Form -->
  <div class="comment-form-section">
    <h4 class="section-title">
      {{ "our_story.comments.leave_comment_message" | translate }}
    </h4>

    <form
      [formGroup]="commentForm"
      (ngSubmit)="onSubmit()"
      class="comment-form"
    >
      <div class="form-group">
        <label for="authorName" class="form-label">Nickname *</label>
        <input
          type="text"
          id="authorName"
          formControlName="authorName"
          class="form-input"
          [placeholder]="'our_story.comments.nickname_placeholder' | translate"
          [class.error]="
            commentForm.get('authorName')?.invalid &&
            commentForm.get('authorName')?.touched
          "
        />

        @if (commentForm.get('authorName')?.invalid &&
        commentForm.get('authorName')?.touched) {
        <div class="error-message">{{ getErrorMessage("authorName") }}</div>
        }
      </div>

      <div class="form-group">
        <label for="messageHtml" class="form-label">
          {{ "our_story.comments.comment" | translate }} *
        </label>

        <app-rich-text-editor
          id="messageHtml"
          formControlName="messageHtml"
          [placeholder]="'our_story.comments.write_comment' | translate"
          [emojiEnabled]="true"
          (lengthChange)="commentCharCount = $event"
          [error]="!!(messageControl?.invalid && messageControl?.touched)"
        >
        </app-rich-text-editor>

        <div class="char-count">
          {{ commentCharCount || 0 }}/{{ maxCommentLength }}
        </div>

        @if (commentForm.get('messageHtml')?.invalid &&
        commentForm.get('messageHtml')?.touched) {
        <div class="error-message">{{ getErrorMessage("messageHtml") }}</div>
        }
      </div>

      <app-security-consent
        [form]="commentForm"
        [submitted]="isCommentSubmitting"
        captchaControlName="captchaCommentCreate"
        privacyControlName="privacyCommentCreate"
      />

      <button
        type="submit"
        class="submit-btn"
        [disabled]="commentForm.invalid || isCommentSubmitting"
      >
        @if (!isCommentSubmitting) {
        {{ "our_story.comments.submit" | translate }}
        } @else {
        {{ "our_story.comments.submitting" | translate }}
        }
      </button>
    </form>
  </div>

  <!-- Subscriptions -->
  <div class="subscriptions-section" [formGroup]="subscriptionForm">
    <div class="section-title">
      <h4>{{ "our_story.comments.subscriptions.title" | translate }}</h4>
    </div>

    <div id="subscriptions-content" class="subscriptions-body">
      <p class="section-helper">
        {{ "our_story.comments.subscriptions.description" | translate }}
      </p>

      <div class="subscribe-row">
        <input
          id="subEmail"
          type="email"
          class="form-input"
          formControlName="email"
          [class.error]="
            subscriptionEmailControl?.invalid &&
            subscriptionEmailControl?.touched
          "
          [placeholder]="
            'our_story.comments.subscriptions.notify_email_placeholder'
              | translate
          "
        />

        <app-security-consent
          [form]="subscriptionForm"
          [submitted]="isSubscribing"
          captchaControlName="captchaSubscription"
          privacyControlName="privacySubscription"
        />

        <div class="actions">
          <button
            type="button"
            class="submit-btn"
            (click)="subscribe()"
            [disabled]="subscriptionForm.invalid || isSubscribing"
          >
            @if (!isSubscribing) {
            {{ "our_story.comments.subscriptions.subscribe" | translate }}
            } @else {
            {{ "our_story.comments.subscriptions.subscribing" | translate }}
            }
          </button>

        </div>
      </div>

      @if (subscriptionEmailControl?.invalid &&
      subscriptionEmailControl?.touched) {
      <div class="error-message">
        {{
          "our_story.comments.subscriptions.notify_email_invalid" | translate
        }}
      </div>
      }
    </div>
  </div>
</div>
