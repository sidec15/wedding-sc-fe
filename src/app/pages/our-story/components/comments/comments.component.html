<div class="comments-section">
  <!-- Comments List Section -->
  <div class="comments-list-section">
    <h4 class="section-title section-title--with-actions">
      {{ "our_story.comments.title" | translate }}
      ({{ totalCount ?? comments.length }})

      <!-- Subscribe bell -->
      <button
        type="button"
        class="icon-btn subscribe-bell"
        (click)="toggleSubscribeBox()"
        [attr.aria-expanded]="showSubscribeBox"
        [attr.aria-label]="
          (isSubscribed
            ? 'our_story.comments.subscriptions.unsubscribe'
            : 'our_story.comments.subscriptions.subscribe') | translate
        "
      >
        @if (isSubscribed) {
          <!-- Bell active -->
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
            <path d="M12 2a6 6 0 0 0-6 6v3.5l-1.7 3.4a1 1 0 0 0 .9 1.5h15.6a1 1 0 0 0 .9-1.5L18 11.5V8a6 6 0 0 0-6-6Z"/>
            <path d="M9 19a3 3 0 0 0 6 0H9Z"/>
            <path d="M4 4l2 2M20 4l-2 2"/>
          </svg>
        } @else {
          <!-- Bell inactive -->
          <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
            <path d="M12 2a6 6 0 0 0-6 6v3.5l-1.7 3.4a1 1 0 0 0 .9 1.5h15.6a1 1 0 0 0 .9-1.5L18 11.5V8a6 6 0 0 0-6-6Z"/>
            <path d="M9 19a3 3 0 0 0 6 0H9Z"/>
          </svg>
        }
      </button>
    </h4>

    <!-- Subscribe box -->
    @if (showSubscribeBox) {
      <div class="subscribe-box">
        <label for="subEmail" class="form-label">
          {{ "our_story.comments.subscriptions.notify_email_label" | translate }}
        </label>

        <div class="subscribe-row">
          <input
            id="subEmail"
            type="email"
            class="form-input"
            [class.error]="subEmailCtrl?.invalid && subEmailCtrl?.touched"
            [placeholder]="
              'our_story.comments.subscriptions.notify_email_placeholder'
                | translate
            "
            [formControl]="subscriptionForm.controls.email"
          />

          @if (!isSubscribed) {
            <button
              type="button"
              class="submit-btn"
              (click)="subscribe()"
              [disabled]="subscriptionForm.invalid || isSubscribing"
            >
              @if (!isSubscribing) {
                {{
                  "our_story.comments.subscriptions.subscribe" | translate
                }}
              } @else {
                {{
                  "our_story.comments.subscriptions.subscribing" | translate
                }}
              }
            </button>
          } @else {
            <button
              type="button"
              class="submit-btn secondary"
              (click)="unsubscribe()"
              [disabled]="isUnsubscribing"
            >
              @if (!isUnsubscribing) {
                {{
                  "our_story.comments.subscriptions.unsubscribe" | translate
                }}
              } @else {
                {{
                  "our_story.comments.subscriptions.unsubscribing" | translate
                }}
              }
            </button>
          }
        </div>

        @if (subEmailCtrl?.invalid && subEmailCtrl?.touched) {
          <div class="error-message">
            {{
              "our_story.comments.subscriptions.notify_email_invalid"
                | translate
            }}
          </div>
        }
      </div>
    }

    <!-- Initial loader -->
    @if (isInitialLoading) {
      <div class="loading">
        {{ "our_story.comments.loading" | translate }}
      </div>
    }

    @if (!isInitialLoading && comments.length > 0) {
      <div class="comments-list">
        @for (comment of comments; track comment.commentId) {
          <div class="comment-item">
            <div class="comment-header">
              <span class="comment-author">{{ comment.authorName }}</span>
              <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
            </div>

            <div
              class="comment-content"
              [innerHTML]="comment.content | safeHtml"
            ></div>
          </div>
        }

        <!-- Load more -->
        @if (hasNext) {
          <div class="load-more">
            <button
              type="button"
              class="submit-btn"
              (click)="loadComments(false)"
              [disabled]="isLoadingMore"
            >
              @if (!isLoadingMore) {
                {{ "our_story.comments.load_more" | translate }}
              } @else {
                {{ "our_story.comments.loading" | translate }}
              }
            </button>
          </div>
        }
      </div>
    }

    @if (!isInitialLoading && comments.length === 0) {
      <div class="no-comments">
        <p>{{ "our_story.comments.no_comment" | translate }}</p>
      </div>
    }
  </div>

  <!-- Comment Form Section -->
  <div class="comment-form-section">
    <h4 class="section-title">
      {{ "our_story.comments.leave_comment_message" | translate }}
    </h4>

    <form [formGroup]="commentForm" (ngSubmit)="onSubmit()" class="comment-form">
      <div class="form-group">
        <label for="authorName" class="form-label">Nickname *</label>
        <input
          type="text"
          id="authorName"
          formControlName="authorName"
          class="form-input"
          [placeholder]="'our_story.comments.nickname_placeholder' | translate"
          [class.error]="
            commentForm.get('authorName')?.invalid &&
            commentForm.get('authorName')?.touched
          "
        />
        @if (
          commentForm.get('authorName')?.invalid &&
          commentForm.get('authorName')?.touched
        ) {
          <div class="error-message">
            {{ getErrorMessage("authorName") }}
          </div>
        }
      </div>

      <div class="form-group">
        <label for="messageHtml" class="form-label">
          {{ "our_story.comments.comment" | translate }} *
        </label>

        <app-rich-text-editor
          id="messageHtml"
          formControlName="messageHtml"
          [placeholder]="'our_story.comments.write_comment' | translate"
          [emojiEnabled]="true"
          (lengthChange)="currentLen = $event"
          [error]="!!(messageCtrl?.invalid && messageCtrl?.touched)"
        ></app-rich-text-editor>

        <div class="char-count">
          {{ currentLen || 0 }}/{{ maxCommentLength }}
        </div>

        @if (
          commentForm.get('messageHtml')?.invalid &&
          commentForm.get('messageHtml')?.touched
        ) {
          <div class="error-message">
            {{ getErrorMessage("messageHtml") }}
          </div>
        }
      </div>

      <button
        type="submit"
        class="submit-btn"
        [disabled]="commentForm.invalid || isSubmitting"
      >
        @if (!isSubmitting) {
          {{ "our_story.comments.submit" | translate }}
        } @else {
          {{ "our_story.comments.submitting" | translate }}
        }
      </button>
    </form>
  </div>
</div>
